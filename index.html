<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>SUSTAIN ‚Äì Live Shuttle Viewer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html, body { margin:0; height:100%; font-family:system-ui,sans-serif; background:#fff; }
    #map { height:100%; width:100%; }
    body { padding-bottom: calc(env(safe-area-inset-bottom, 0) + 4px); }
    .leaflet-popup-content { font-size:.9rem; line-height:1.3; }

    /* Splash screen */
    #welcome {
      position:fixed; inset:0; background:rgba(0,0,0,.8); color:#fff;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      font-size:1.6rem; z-index:1000; transition:opacity .8s;
    }
    #welcome.hide { opacity:0; pointer-events:none; }

    /* Popup buttons */
    .popup-btn-container { display:flex; justify-content:space-between; margin-top:6px; gap:6px; }
    .popup-btn {
      flex:1; text-align:center; background:#0078ff; color:#fff!important;
      padding:6px 0; border-radius:6px; font-size:.8rem; text-decoration:none;
    }
    .popup-btn:hover { background:#005fcc; }

    /* Legend */
    .legend {
      position:absolute; bottom:82px; left:10px;
      background:rgba(255,255,255,.95); padding:6px 10px;
      border-radius:8px; font-size:.9rem; box-shadow:0 2px 6px rgba(0,0,0,.25);
      z-index:700; overflow-y:auto; max-height:60vh;
      transform-origin: bottom left; transform: scaleY(1);
      opacity: 1; transition: transform .25s ease, opacity .22s ease;
    }
    .legend.collapsed { transform: scaleY(0); opacity:0; pointer-events:none; }
    .legend h4 { margin:0 0 4px; font-size:.95rem; }
    .legend-item {
      display:flex; align-items:center; gap:6px; margin:3px 0;
      cursor:pointer; padding:4px 6px; border-radius:8px;
      transition: background .15s ease, box-shadow .15s ease;
    }
    .legend-item:hover { background:#e6f0ff; }
    .legend-item.active { background:#dbe9ff; box-shadow:0 0 0 2px rgba(0,120,255,.25) inset; }
    .colorbox { width:16px; height:10px; border-radius:3px; }

    /* Status label */
    .status {
      position:absolute; top:10px; right:10px; z-index:700;
      background:rgba(0,0,0,.7); color:#fff; padding:6px 10px;
      border-radius:8px; font-size:.85rem;
    }

    /* Floating logo ‚Äì NO BOX */
    .logo-overlay {
      position:absolute; top:50px; right:10px; z-index:700;
      background:transparent !important;
      padding:0; border-radius:0; box-shadow:none !important;
      opacity:0; transition:opacity 1s ease-in;
    }
    .logo-overlay.show { opacity:1; }
    .logo-overlay img {
      width:64px; height:64px; object-fit:contain;
      background:none !important;
      box-shadow:none !important;
      border-radius:0 !important;
    }

    /* Controls */
    .controls {
      position:absolute; bottom:8px; left:50%; transform:translateX(-50%);
      display:grid; grid-template-columns:repeat(9,36px); gap:6px;
      z-index:800; max-width:calc(100vw - 16px);
      padding-bottom:env(safe-area-inset-bottom,0);
    }
    .controls button {
      width:36px; height:36px; border:none; border-radius:10px;
      font-size:18px; cursor:pointer; background:rgba(255,255,255,.95);
      box-shadow:0 2px 6px rgba(0,0,0,.25);
    }
    .controls button:active { transform:scale(.97); }
    .controls button[disabled] { opacity:.5; cursor:not-allowed; }

    @media (max-width:380px){
      .controls{ grid-template-columns:repeat(9,32px); gap:4px; }
      .controls button{ width:32px; height:32px; font-size:16px; border-radius:8px; }
    }

    /* Remove Leaflet attribution */
    .leaflet-control-attribution { display:none !important; }
  </style>
</head>
<body>

  <div id="welcome">üöå <b>Welcome to Live Bus Viewer</b><br/><small style="opacity:.8)">Loading map‚Ä¶</small></div>

  <div id="map"></div>

  <div class="legend" id="legend" aria-expanded="true"><h4>üöå Active Buses</h4></div>
  <div class="status" id="status">Loading‚Ä¶</div>

  <!-- Widad UC Logo -->
  <a href="https://www.widad.edu.my/uc/my" target="_blank"
     class="logo-overlay" id="logoOverlay">
    <img src="https://pbs.twimg.com/profile_images/1281083290254893056/gGxC3vN3_400x400.jpg">
  </a>

  <div class="controls">
    <button id="btnHome">üè†</button>
    <button id="btnPrev">‚óÄÔ∏è</button>
    <button id="btnRecenter">üîÑ</button>
    <button id="btnNext">‚ñ∂Ô∏è</button>
    <button id="btnMyLoc">üìç</button>
    <button id="btnMapType">üó∫Ô∏è</button>
    <button id="btnLegend">üôà</button>
    <button id="btnFollow">üéØ</button>
    <button id="btnWake">üí§</button>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>

    /* Splash / Logo */
    const welcome=document.getElementById('welcome');
    const logoOverlay=document.getElementById('logoOverlay');
    setTimeout(()=>{ welcome.classList.add('hide'); logoOverlay.classList.add('show'); setTimeout(()=>welcome.remove(),1000); },2000);

    /* CONFIG */
    const WEB_APP_URL="https://script.google.com/macros/s/AKfycby6mh0UYXsQyms8ZHWGl5fgDM2yUCBH7TfQ53zTS810KGLS8rLFFcijVTpGpoo2Ab5uAg/exec";
    const REFRESH_SEC=10;
    const TRAIL_LIMIT_PER_DAY=200;
    const HOME=L.latLng(3.543784470063409,103.42902640748252);

    /* MAP */
    const map=L.map('map',{zoomControl:true,attributionControl:false}).setView([3.54,103.43],13);
    const layers={
      osm:L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'),
      img:L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'),
      streets:L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}')
    };

    map.createPane('labels');
    map.getPane('labels').style.zIndex=650;
    map.getPane('labels').style.pointerEvents='none';

    const labels=L.tileLayer('https://stamen-tiles.a.ssl.fastly.net/toner-labels/{z}/{x}/{y}.png',{pane:'labels',opacity:.9});

    let baseOrder=['osm','img','streets'], baseIdx=0;
    let baseLayer=layers[baseOrder[baseIdx]].addTo(map);
    labels.addTo(map);

    function switchMapType(){
      map.removeLayer(baseLayer);
      baseIdx=(baseIdx+1)%baseOrder.length;
      baseLayer=layers[baseOrder[baseIdx]].addTo(map);
      if(!map.hasLayer(labels)) labels.addTo(map);
    }

    /* STATUS */
    const statusEl=document.getElementById('status');
    let statusHoldUntil=0;
    function setStatus(msg,hold=0){ statusEl.textContent=msg; statusHoldUntil=hold?Date.now()+hold:0; }
    function maybeStatus(msg){ if(Date.now()>statusHoldUntil) statusEl.textContent=msg; }

    /* STATE */
    const buses={};
    const legendEl=document.getElementById('legend');
    let busList=[], currentFocusId=null, myLocMarker=null;
    let followEnabled=true, firstLoadDone=false;

    /* Reverse Geocode Cache */
    const addrCache=new Map();
    async function getStreetName(lat,lng){
      const key=lat.toFixed(5)+','+lng.toFixed(5);
      if(addrCache.has(key)) return addrCache.get(key);
      try{
        const res=await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&accept-language=en`);
        const js=await res.json();
        const name=js.display_name||'';
        addrCache.set(key,name);
        return name;
      }catch{ addrCache.set(key,''); return ''; }
    }

    /* Muted Colors */
    const muted=[
      '#2E86AB','#6C5B7B','#E07A5F','#3D405B','#8D99AE',
      '#2A9D8F','#7F7CAF','#E76F51','#5C677D','#9C6644',
      '#5B8FB9','#7D7461','#B56576','#6B705C','#7A9E9F'
    ];
    let colIdx=0;  
    const nextColor=()=>muted[(colIdx++)%muted.length];

    /* Bus Icon */
    function makeBusIcon(id,color){
      return L.divIcon({
        html:`<div style="width:46px;height:46px;border-radius:50%;
               background:#fff;border:3px solid ${color};
               display:flex;flex-direction:column;align-items:center;justify-content:center;
               box-shadow:0 2px 6px rgba(0,0,0,.35);">
                <div style="font-size:12px;color:${color};font-weight:700;">${id}</div>
                <div style="font-size:20px;">üöå</div>
              </div>`,
        iconSize:[46,46],iconAnchor:[23,23]
      });
    }

    /* Follow off on map movement */
    map.on('dragstart',()=>{
      if(followEnabled){
        followEnabled=false;
        btnFollow.textContent='üö´';
        btnFollow.title='Follow OFF';
        setStatus('Follow OFF (drag)',2000);
      }
    });
    map.on('zoomstart',()=>{
      if(followEnabled){
        followEnabled=false;
        btnFollow.textContent='üö´';
        btnFollow.title='Follow OFF';
        setStatus('Follow OFF (zoom)',2000);
      }
    });

    function centerTo(ll){ map.setView(ll,map.getZoom(),{animate:true}); }

    /* Trail limiter */
    function todaysLimitedRows(rows){
      const today=new Date(rows[0].timestamp).toDateString();
      const t=rows.filter(r=>new Date(r.timestamp).toDateString()===today);
      return t.slice(0,TRAIL_LIMIT_PER_DAY).reverse();
    }

    /* Popup builder */
    function buildPopup(id,row,addr){
      const lines=[];
      if(row.destination) lines.push(`Destination: ${row.destination}`);
      if(row.driver)      lines.push(`Driver: ${row.driver}`);
      if(row.plate)       lines.push(`Plate: ${row.plate}`);
      if(row.speed_mps>0) lines.push(`Speed: ${(row.speed_mps*3.6).toFixed(1)} km/h`);
      if(addr)            lines.push(`Current location: ${addr}`);
      if(row.timestamp)   lines.push(`Last update: ${new Date(row.timestamp).toLocaleString()}`);

      const link=`https://www.google.com/maps?q=${row.lat},${row.lng}`;
      const dir =`https://www.google.com/maps/dir/?api=1&destination=${row.lat},${row.lng}`;

      return `<b>Bus ${id}</b><br>${lines.join('<br>')}
        <div class="popup-btn-container">
         <a target="_blank" href="${link}" class="popup-btn">üìç Open in Maps</a>
         <a target="_blank" href="${dir}"  class="popup-btn">üöó Get Directions</a>
        </div>`;
    }

    function rebuildBusList(data){
      busList=Object.keys(data).sort();
      if(!currentFocusId||!busList.includes(currentFocusId))
        currentFocusId=busList[0]||null;
    }

    function highlightLegend(id){
      document.querySelectorAll('.legend-item').forEach(x=>x.classList.remove('active'));
      const row=document.querySelector(`.legend-item[data-id="${CSS.escape(id)}"]`);
      if(row) row.classList.add('active');
    }

    function focusBus(id,{openPopup=false}={}){
      if(!buses[id])return;
      currentFocusId=id;

      Object.keys(buses).forEach(k=>{
        const b=buses[k];
        if(k===id){ b.marker.setZIndexOffset(1000); b.trail.bringToFront(); }
        else{ b.marker.setZIndexOffset(0); b.trail.bringToBack(); }
      });

      if(followEnabled) centerTo(buses[id].marker.getLatLng());
      if(openPopup) buses[id].marker.openPopup();
      highlightLegend(id);
      setStatus(`Focused: ${id}`,1500);
    }

    function ensureMarkerClick(id){
      const b=buses[id];
      if(b._bound)return;
      b._bound=true;

      b.marker.on('click',async()=>{
        const ll=b.marker.getLatLng();
        const addr=await getStreetName(ll.lat,ll.lng);
        b.marker.bindPopup(buildPopup(id,b.latestRow,addr)).openPopup();
        focusBus(id,{openPopup:false});
      });
    }

    function buildLegendEntry(id,dest,color,isToday){
      const el=document.createElement('div');
      el.className='legend-item';
      el.dataset.id=id;
      el.style.color=isToday?'#0B4F2F':'#000';
      el.innerHTML=`<div class="colorbox" style="background:${color}"></div>${id}${dest?` (${dest})`:''}`;
      el.onclick=()=>{ followEnabled=true; btnFollow.textContent='üéØ'; focusBus(id); };
      return el;
    }

    async function updateMap(data){
      legendEl.innerHTML='<h4>üöå Active Buses</h4>';
      const ids=Object.keys(data);
      let any=false;

      for(const id of ids){
        const rows=data[id];
        if(!rows||!rows.length)continue;

        const latest=rows[0];
        const lat=+latest.lat, lng=+latest.lng;
        if(!isFinite(lat)||!isFinite(lng))continue;
        any=true;

        if(!buses[id]){
          const color=nextColor();
          const marker=L.marker([lat,lng],{icon:makeBusIcon(id,color)}).addTo(map);
          const trail=L.polyline([], {color,weight:5,opacity:.85}).addTo(map);
          buses[id]={marker,trail,color,latestRow:latest};
        } else {
          buses[id].latestRow=latest;
        }

        const b=buses[id];
        const todayRows=todaysLimitedRows(rows);
        b.trail.setLatLngs(todayRows.map(p=>[+p.lat,+p.lng]));
        b.marker.setLatLng([lat,lng]);
        b.marker.bindPopup(buildPopup(id,latest,''));

        ensureMarkerClick(id);

        const isToday=new Date(latest.timestamp).toDateString()===new Date().toDateString();
        legendEl.appendChild(buildLegendEntry(id,latest.destination,b.color,isToday));
      }

      /* Remove inactive */
      Object.keys(buses).forEach(id=>{
        if(!ids.includes(id)){
          map.removeLayer(buses[id].marker);
          map.removeLayer(buses[id].trail);
          delete buses[id];
        }
      });

      rebuildBusList(data);

      if(!firstLoadDone && currentFocusId){
        followEnabled=true; btnFollow.textContent='üéØ';
        focusBus(currentFocusId);
        firstLoadDone=true;
      }

      if(followEnabled&&currentFocusId&&buses[currentFocusId])
        centerTo(buses[currentFocusId].marker.getLatLng());

      if(currentFocusId) highlightLegend(currentFocusId);

      maybeStatus(any?`Updated: ${new Date().toLocaleTimeString()}`:'No buses');
    }

    async function refresh(){
      try{
        const res=await fetch(WEB_APP_URL+'?json=1',{cache:'no-store'});
        const js=await res.json();
        if(js.ok) updateMap(js.buses);
        else maybeStatus('Failed to load');
      }catch(err){ maybeStatus('Fetch error'); }
    }
    refresh();
    setInterval(refresh,REFRESH_SEC*1000);

    /* Controls */
    const btnHome=document.getElementById('btnHome');
    const btnPrev=document.getElementById('btnPrev');
    const btnRecenter=document.getElementById('btnRecenter');
    const btnNext=document.getElementById('btnNext');
    const btnMyLoc=document.getElementById('btnMyLoc');
    const btnMapType=document.getElementById('btnMapType');
    const btnLegend=document.getElementById('btnLegend');
    const btnFollow=document.getElementById('btnFollow');
    const btnWake=document.getElementById('btnWake');

    btnHome.onclick=()=>{
      centerTo(HOME);
      followEnabled=false; btnFollow.textContent='üö´';
      setStatus('Home (follow OFF)',2000);
    };

    btnPrev.onclick=()=>{
      if(!busList.length) return;
      const i=busList.indexOf(currentFocusId);
      const id=(i<=0)?busList[busList.length-1]:busList[i-1];
      followEnabled=true; btnFollow.textContent='üéØ';
      focusBus(id);
    };

    btnNext.onclick=()=>{
      if(!busList.length) return;
      const i=busList.indexOf(currentFocusId);
      const id=busList[(i+1)%busList.length];
      followEnabled=true; btnFollow.textContent='üéØ';
      focusBus(id);
    };

    btnRecenter.onclick=()=>{
      if(currentFocusId&&buses[currentFocusId]){
        followEnabled=true; btnFollow.textContent='üéØ';
        centerTo(buses[currentFocusId].marker.getLatLng());
        highlightLegend(currentFocusId);
        setStatus('Recentered',1500);
      }
    };

    btnMyLoc.onclick=()=>{
      if(!navigator.geolocation)return;
      navigator.geolocation.getCurrentPosition(pos=>{
        const ll=L.latLng(pos.coords.latitude,pos.coords.longitude);
        if(!myLocMarker){
          myLocMarker=L.marker(ll,{icon:L.divIcon({html:'üìç',iconSize:[20,20]})}).addTo(map);
        } else myLocMarker.setLatLng(ll);

        centerTo(ll);
        followEnabled=false; btnFollow.textContent='üö´';
        setStatus('My location',1500);
      });
    };

    btnMapType.onclick=()=>{ switchMapType(); setStatus('Map switched',1500); };

    btnLegend.onclick=()=>{
      const c=legendEl.classList.toggle('collapsed');
      btnLegend.textContent=c?'üëÅÔ∏è':'üôà';
      setStatus(c?'Legend hidden':'Legend shown',1500);
    };

    btnFollow.onclick=()=>{
      followEnabled=!followEnabled;
      btnFollow.textContent=followEnabled?'üéØ':'üö´';
      if(followEnabled && currentFocusId && buses[currentFocusId])
        centerTo(buses[currentFocusId].marker.getLatLng());
    };

    /* Wake Lock */
    let wakeLock=null;
    async function requestWake(){
      try{
        if('wakeLock'in navigator){
          wakeLock=await navigator.wakeLock.request('screen');
          btnWake.textContent='üîÜ';
          wakeLock.addEventListener('release',()=>{ wakeLock=null; btnWake.textContent='üí§'; });
        }
      }catch{}
    }
    async function releaseWake(){ if(wakeLock) await wakeLock.release(); wakeLock=null; btnWake.textContent='üí§'; }

    btnWake.onclick=()=>{ if(wakeLock) releaseWake(); else requestWake(); };

    document.addEventListener('visibilitychange',()=>{
      if(document.visibilityState==='visible' && wakeLock)
        requestWake();
    });

  </script>
</body>
</html>
