<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Live Bus Viewer</title>
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html, body {
      margin:0;
      height:100%;
      font-family:system-ui, sans-serif;
      background:#fff;
      touch-action:manipulation;
    }
    #map { height:100%; width:100%; }
    body {
      padding-bottom: calc(env(safe-area-inset-bottom, 0) + 4px);
    }
    .leaflet-popup-content { font-size:.9rem; line-height:1.3; }
    .leaflet-div-icon { background:transparent!important; border:none!important; }

    /* Move zoom control to bottom-right, above buttons */
    .leaflet-control-zoom {
      position:absolute;
      bottom:56px;
      right:10px;
      top:auto;
      left:auto;
    }

    /* Title overlay */
    .title-overlay {
      position:absolute;
      top:6px;
      left:50%;
      transform:translateX(-50%);
      z-index:750;
      font-size:1.25rem;
      font-weight:700;
      color:#fff;
      text-shadow:0 0 4px rgba(0,0,0,.9);
      pointer-events:none;
      white-space:nowrap;
    }

    /* Status (green update label) between title and logo */
    .status {
      position:absolute;
      top:140px;              /* between title (6px) and logo bar (44px) */
      left:50%;
      transform:translateX(-50%);
      z-index:755;
      padding:4px 8px;
      background:#004d00;
      color:#fff;
      font-size:.78rem;
      border-radius:6px;
      white-space:nowrap;
      box-shadow:0 2px 4px rgba(0,0,0,.35);
    }

    /* Top bar (logo + collapsible filters) */
    .topbar {
      position:absolute;
      top:44px;
      left:50%;
      transform:translateX(-50%);
      z-index:760;
      display:flex;
      align-items:center;
      gap:8px;

      background:transparent;
      padding:0;
      border-radius:999px;
      box-shadow:none;
      max-width:calc(100vw - 20px);

      transition:
        background .25s ease,
        box-shadow .25s ease,
        padding .25s ease;
    }

    .topbar.open {
      background:rgba(255,255,255,0.94);
      padding:4px 8px;
      box-shadow:0 2px 6px rgba(0,0,0,.25);
    }

    .topbar-inner {
      display:flex;
      align-items:center;
      gap:8px;
      overflow:hidden;
      max-width:0;
      opacity:0;
      transform:scaleX(0);
      transform-origin:right center;
      transition:
        max-width .25s ease,
        opacity .2s ease,
        transform .25s ease;
      white-space:nowrap;
    }
    .topbar.open .topbar-inner {
      max-width:500px;
      opacity:1;
      transform:scaleX(1);
    }

    .route-filter {
      display:flex;
      align-items:center;
      gap:4px;
      font-size:.82rem;
    }
    .route-filter label {
      font-weight:600;
    }
    .route-filter select {
      border-radius:6px;
      padding:3px 6px;
      font-size:.82rem;
      border:1px solid #ccc;
      background:#fff;
    }

    .today-check {
      display:flex;
      align-items:center;
      gap:3px;
      font-size:.8rem;
      margin-left:4px;
    }

    .logo-btn {
      border:none;
      background:transparent;
      padding:0;
      cursor:pointer;
      border-radius:50%;
      flex-shrink:0;
    }

    .logo-btn img {
      width:40px;
      height:40px;
      border-radius:50%;
      border:3px solid #ffffff;
      background:#fff;
      object-fit:contain;
      filter:drop-shadow(0 2px 5px rgba(0,0,0,.45));
      transition:
        border-color .25s ease,
        box-shadow .25s ease,
        transform .25s ease;
    }

    @keyframes logoPulse {
      0% {
        box-shadow:0 0 0 0 rgba(255,255,255,0.8);
        transform:scale(1.03);
      }
      50% {
        box-shadow:0 0 0 8px rgba(255,255,255,0);
        transform:scale(1.08);
      }
      100% {
        box-shadow:0 0 0 0 rgba(255,255,255,0.8);
        transform:scale(1.03);
      }
    }

    .topbar.open .logo-btn img {
      animation:logoPulse 1.6s ease-out infinite;
    }

    /* Bottom-left panel: legend only, moved lower */
    .bottom-left-panel {
      position:absolute;
      left:10px;
      bottom:64px; /* above button row & zoom control */
      z-index:700;
      display:flex;
      flex-direction:column;
      gap:4px;
      max-width:calc(100vw - 20px);
      transition:all .2s ease;
    }

    /* Legend */
    .legend {
      background:rgba(255,255,255,.95);
      padding:6px 10px;
      border-radius:8px;
      font-size:.9rem;
      box-shadow:0 2px 6px rgba(0,0,0,.25);
      max-height:60vh;
      overflow-y:auto;
      transition:transform .25s ease, opacity .22s ease;
    }
    .legend h4 { margin:0 0 4px; font-size:.95rem; }

    .legend-caption {
      font-size:.75rem;
      color:#444;
      margin-bottom:2px;
      display:flex;
      align-items:center;
      gap:4px;
      flex-wrap:wrap;
    }
    .legend-dot {
      width:10px;
      height:10px;
      border-radius:50%;
      display:inline-block;
      flex-shrink:0;
    }
    .legend-dot-today { background:#006400; }
    .legend-dot-old { background:#000; }
    .legend-sep {
      margin:0 4px;
      opacity:.7;
    }

    .legend-hide-note {
      font-size:.75rem;
      color:#444;
      font-style:italic;
      margin-bottom:4px;
    }

    .legend-item {
      display:flex;
      align-items:center;
      gap:6px;
      margin:3px 0;
      padding:4px 6px;
      cursor:pointer;
      border-radius:8px;
      transition:background .15s ease, box-shadow .15s ease, transform .1s ease;
    }
    .legend-item:hover { background:#e6f0ff; }
    .legend-item.active {
      background:#dbe9ff;
      box-shadow:0 0 0 2px rgba(0,120,255,.25) inset;
      transform:translateX(1px);
    }
    .colorbox {
      width:16px;
      height:10px;
      border-radius:3px;
    }

    .legend.collapsed {
      transform:scaleY(0);
      opacity:0;
      pointer-events:none;
      transform-origin:top left;
    }

    /* Controls */
    .controls {
      position:absolute;
      bottom:8px;
      left:50%;
      transform:translateX(-50%);
      display:grid;
      grid-template-columns:repeat(9,36px);
      gap:6px;
      z-index:800;
      max-width:calc(100vw - 16px);
      padding-bottom:env(safe-area-inset-bottom,0);
    }
    .controls button {
      width:36px;
      height:36px;
      border:none;
      border-radius:10px;
      font-size:18px;
      cursor:pointer;
      background:rgba(255,255,255,.95);
      box-shadow:0 2px 6px rgba(0,0,0,.25);
    }
    .controls button:active { transform:scale(.97); }
    .controls button[disabled] { opacity:.5; cursor:not-allowed; }

    @media (max-width:380px){
      .controls{ grid-template-columns:repeat(9,32px); gap:4px; }
      .controls button{ width:32px; height:32px; font-size:16px; border-radius:8px; }
    }

    /* Hide attribution */
    .leaflet-control-attribution { display:none!important; }
  </style>
</head>
<body>
  <div class="title-overlay">WIDAD UC SHUTTLE TRACKER</div>

  <!-- Status label between title & logo -->
  <div class="status" id="status">Loading‚Ä¶</div>

  <!-- Top bar: logo toggles expansion of filters -->
  <div class="topbar" id="topbar">
    <div class="topbar-inner" id="topbarInner">
      <div class="route-filter">
        <label for="routeFilter">Route:</label>
        <select id="routeFilter">
          <option value="ALL">All Routes</option>
        </select>

        <label class="today-check">
          <input type="checkbox" id="todayOnly" />
          Today only
        </label>
      </div>
    </div>

    <button class="logo-btn" id="logoBtn" title="Tap to show/hide filters">
      <img src="https://upload.wikimedia.org/wikipedia/commons/2/25/Widad_University_College_Logo.jpg"
           alt="Widad UC Logo" />
    </button>
  </div>

  <div id="map"></div>

  <!-- Legend bottom-left -->
  <div class="bottom-left-panel" id="bottomLeftPanel">
    <div class="legend" id="legend">
      <h4>üöå Active Shuttles</h4>
      <div class="legend-caption">
        <span class="legend-dot legend-dot-today"></span><span>updated today</span>
        <span class="legend-sep">¬∑</span>
        <span class="legend-dot legend-dot-old"></span><span>older</span>
      </div>
      <div class="legend-hide-note"><em>(Tap üôà to hide)</em></div>
    </div>
  </div>

  <div class="controls">
    <button id="btnHome" title="Home">üè†</button>
    <button id="btnPrev" title="Previous route">‚óÄÔ∏è</button>
    <button id="btnRecenter" title="Recenter">üîÑ</button>
    <button id="btnNext" title="Next route">‚ñ∂Ô∏è</button>
    <button id="btnMyLoc" title="My location">üìç</button>
    <button id="btnMapType" title="Switch map">üó∫Ô∏è</button>
    <button id="btnLegend" title="Hide Active Shuttles">üôà</button>
    <button id="btnFollow" title="Follow shuttle">üéØ</button>
    <button id="btnWake" title="Keep screen on">üí§</button>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    /* Prevent double-tap zoom (especially on iOS Safari) */
    let lastTouchEnd = 0;
    document.addEventListener('touchend', function (event) {
      const now = Date.now();
      if (now - lastTouchEnd <= 300) {
        event.preventDefault();
      }
      lastTouchEnd = now;
    }, { passive:false });

    /* Config */
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycby6mh0UYXsQyms8ZHWGl5fgDM2yUCBH7TfQ53zTS810KGLS8rLFFcijVTpGpoo2Ab5uAg/exec";
    const REFRESH_SEC = 10;
    const TRAIL_LIMIT_PER_DAY = 200;
    const HOME = L.latLng(3.8235798, 103.2799927);  // home coords

    /* DOM */
    const legendEl = document.getElementById('legend');
    const statusEl = document.getElementById('status');
    const routeFilterEl = document.getElementById('routeFilter');
    const todayOnlyEl = document.getElementById('todayOnly');
    const topbar = document.getElementById('topbar');
    const logoBtn = document.getElementById('logoBtn');
    const bottomLeftPanel = document.getElementById('bottomLeftPanel');

    const btnHome = document.getElementById('btnHome');
    const btnPrev = document.getElementById('btnPrev');
    const btnRecenter = document.getElementById('btnRecenter');
    const btnNext = document.getElementById('btnNext');
    const btnMyLoc = document.getElementById('btnMyLoc');
    const btnMapType = document.getElementById('btnMapType');
    const btnLegend = document.getElementById('btnLegend');
    const btnFollow = document.getElementById('btnFollow');
    const btnWake = document.getElementById('btnWake');

    /* Map + layers */
    const map = L.map('map', { zoomControl:true, attributionControl:false }).setView(HOME,13);
    const layers = {
      osm: L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'),
      esriImagery: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'),
      esriStreets: L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}')
    };
    map.createPane('labels');
    map.getPane('labels').style.zIndex = 650;
    map.getPane('labels').style.pointerEvents = 'none';
    const labels = L.tileLayer('https://stamen-tiles.a.ssl.fastly.net/toner-labels/{z}/{x}/{y}.png', {
      pane:'labels', opacity:0.9
    });
    let baseOrder = ['osm','esriImagery','esriStreets'], baseIdx = 0;
    let baseLayer = layers[baseOrder[baseIdx]].addTo(map);
    if (!map.hasLayer(labels)) labels.addTo(map);

    /* Shared circular chip style for markers (home & my location) */
    function makeCircleChip(contentEmoji, borderColor) {
      return `
        <div style="
          width:40px;height:40px;
          border-radius:50%;
          background:#fff;
          border:3px solid ${borderColor};
          display:flex;
          align-items:center;
          justify-content:center;
          box-shadow:0 2px 6px rgba(0,0,0,.3);
        ">
          <div style="font-size:20px;line-height:20px;">${contentEmoji}</div>
        </div>
      `;
    }

    /* Home marker ‚Äì green circle chip */
    const homeMarker = L.marker(HOME, {
      icon: L.divIcon({
        className:'home-marker',
        html: makeCircleChip('üè´', '#2E7D32'),
        iconSize:[44,44],
        iconAnchor:[22,22]
      })
    }).addTo(map);

    /* Status manager */
    let statusHoldUntil = 0;
    function setStatus(msg, holdMs=0){
      statusEl.textContent = msg;
      statusHoldUntil = holdMs>0 ? Date.now()+holdMs : 0;
    }
    function maybeStatus(msg){
      if (Date.now()>statusHoldUntil) statusEl.textContent = msg;
    }

    /* Palette (muted colors) */
    const mutedPalette = [
      '#2E86AB','#6C5B7B','#E07A5F','#3D405B','#8D99AE',
      '#2A9D8F','#7F7CAF','#E76F51','#5C677D','#9C6644',
      '#5B8FB9','#7D7461','#B56576','#6B705C','#7A9E9F'
    ];
    let paletteIdx = 0;
    const nextMutedColor = () => mutedPalette[(paletteIdx++) % mutedPalette.length];

    /* Circular bus icon */
    function makeBusIcon(id,color){
      return L.divIcon({
        className:'bus-icon',
        html:`
          <div style="
            width:44px;height:44px;border-radius:50%;
            background:#fff;border:3px solid ${color};
            display:flex;flex-direction:column;align-items:center;justify-content:center;
            box-shadow:0 2px 6px rgba(0,0,0,.3);">
            <div style="font-size:12px;color:${color};font-weight:700;line-height:12px;">
              ${id}
            </div>
            <div style="font-size:20px;line-height:20px;">üöå</div>
          </div>`,
        iconSize:[44,44],
        iconAnchor:[22,22]
      });
    }

    /* State */
    const buses = {}; // id -> {marker, trail, color, latestRow}
    let busList = [];
    let currentFocusId = null;
    let myLocMarker = null;
    let followEnabled = true;
    let firstLoadDone = false;
    let lastSnapshot = null;

    function centerTo(ll){
      map.setView(ll, map.getZoom(), { animate:true });
    }

    function isTodayDate(ts){
      if(!ts) return false;
      const d = new Date(ts);
      return d.toDateString() === new Date().toDateString();
    }

    /* Trails: only today's points, up to TRAIL_LIMIT_PER_DAY */
    function todaysLimitedRows(rows){
      if(!rows || !rows.length) return [];
      const todayStr = new Date().toDateString();
      const todayRows = rows.filter(r => new Date(r.timestamp).toDateString() === todayStr);
      const sliced = todayRows.slice(0, TRAIL_LIMIT_PER_DAY);
      return sliced.reverse(); // chronological for polyline
    }

    /* Reverse-geocode cache */
    const addrCache = new Map();
    async function getStreetName(lat,lng){
      const key = lat.toFixed(5)+','+lng.toFixed(5);
      if (addrCache.has(key)) return addrCache.get(key);
      try{
        const res = await fetch(
          `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}&accept-language=en`,
          { headers:{'User-Agent':'Widad-Shuttle-Viewer/1.0'} }
        );
        if (!res.ok){ addrCache.set(key,''); return ''; }
        const js = await res.json();
        const name = js.display_name || '';
        addrCache.set(key,name);
        return name;
      }catch{
        addrCache.set(key,'');
        return '';
      }
    }

    /* Popup HTML: conditional fields */
    function buildPopup(id,row,addrText){
      const lines = [];
      if (row.destination) lines.push(`Destination: ${row.destination}`);
      if (row.driver)      lines.push(`Driver: ${row.driver}`);
      if (row.plate)       lines.push(`Plate: ${row.plate}`);
      if (row.speed_mps && row.speed_mps > 0){
        lines.push(`Speed: ${(row.speed_mps*3.6).toFixed(1)} km/h`);
      }
      if (addrText)  lines.push(`Current location: ${addrText}`);
      if (row.timestamp){
        lines.push(`Last update: ${new Date(row.timestamp).toLocaleString()}`);
      }

      const link = `https://www.google.com/maps?q=${row.lat},${row.lng}`;
      const dir  = `https://www.google.com/maps/dir/?api=1&destination=${row.lat},${row.lng}`;

      return `<b>Route ${id}</b><br>${lines.join('<br>')}
        <div class="popup-btn-container">
          <a href="${link}" target="_blank" class="popup-btn">üìç Open in Maps</a>
          <a href="${dir}" target="_blank" class="popup-btn">üöó Get Directions</a>
        </div>`;
    }

    /* Build route filter options */
    function populateRouteFilter(data){
      const existing = new Set();
      const current = routeFilterEl.value || 'ALL';
      existing.add('ALL');
      Object.keys(data).forEach(id => existing.add(id));

      routeFilterEl.innerHTML = '';
      existing.forEach(v=>{
        const opt = document.createElement('option');
        opt.value = v;
        opt.textContent = (v === 'ALL') ? 'All Routes' : v;
        routeFilterEl.appendChild(opt);
      });

      if (existing.has(current)) routeFilterEl.value = current;
      else routeFilterEl.value = 'ALL';
    }

    function rebuildBusList(visibleIdsSet){
      const arr = Array.from(visibleIdsSet);
      arr.sort();
      busList = arr;
      if (!currentFocusId || !visibleIdsSet.has(currentFocusId)){
        currentFocusId = busList[0] || null;
      }
    }

    function highlightLegend(id){
      document.querySelectorAll('.legend-item').forEach(el=>el.classList.remove('active'));
      if (!id) return;
      const row = document.querySelector(`.legend-item[data-busid="${CSS.escape(id)}"]`);
      if (row){
        row.classList.add('active');
        row.scrollIntoView({ block:'nearest', inline:'nearest', behavior:'smooth' });
      }
    }

    function focusBus(id, { openPopup=false } = {}){
      if (!id || !buses[id]) return;
      currentFocusId = id;
      Object.keys(buses).forEach(k=>{
        const b = buses[k];
        if (k === id){
          b.marker.setZIndexOffset(1000);
          b.trail.bringToFront();
          b.trail.setStyle({ opacity:0.85, weight:5 });
        } else {
          b.marker.setZIndexOffset(0);
          b.trail.setStyle({ opacity:0, weight:0 });
        }
      });
      if (followEnabled){
        centerTo(buses[id].marker.getLatLng());
      }
      if (openPopup){
        buses[id].marker.openPopup();
      }
      highlightLegend(id);
      setStatus(`Focused: Route ${id}`, 2000);
    }

    function ensureMarkerClick(id){
      const b = buses[id];
      if (!b || b._clickBound) return;
      b.marker.on('click', async ()=>{
        const ll = b.marker.getLatLng();
        const addr = await getStreetName(ll.lat, ll.lng);
        const latest = b.latestRow || {};
        b.marker.bindPopup( buildPopup(id, latest, addr) ).openPopup();
        focusBus(id, { openPopup:false });
      });
      b._clickBound = true;
    }

    function buildLegendEntry(id, latest, color, isTodayFlag){
      const d = document.createElement('div');
      d.className = 'legend-item';
      d.dataset.busid = id;

      const colorDiv = document.createElement('div');
      colorDiv.className = 'colorbox';
      colorDiv.style.background = color;

      const textDiv = document.createElement('div');
      textDiv.textContent = latest.destination
        ? `${id} (${latest.destination})`
        : id;
      textDiv.style.color = isTodayFlag ? '#006400' : '#000';

      d.appendChild(colorDiv);
      d.appendChild(textDiv);

      d.onclick = ()=>{
        if (buses[id]){
          followEnabled = true;
          btnFollow.textContent = 'üéØ';
          btnFollow.title = 'Follow ON';
          focusBus(id, { openPopup:false });
        }
      };

      return d;
    }

    /* Pause follow on user interactions */
    map.on('dragstart', ()=>{
      if (followEnabled){
        followEnabled = false;
        btnFollow.textContent = 'üö´';
        btnFollow.title = 'Follow OFF';
        setStatus('Follow OFF (map moved)', 2000);
      }
    });
    map.on('zoomstart', ()=>{
      if (followEnabled){
        followEnabled = false;
        btnFollow.textContent = 'üö´';
        btnFollow.title = 'Follow OFF';
        setStatus('Follow OFF (zoom)', 2000);
      }
    });

    async function updateMap(data){
      if (!data) return;
      lastSnapshot = data;
      populateRouteFilter(data);

      const filterRoute = routeFilterEl.value || 'ALL';
      const onlyToday = todayOnlyEl.checked;

      legendEl.innerHTML = `
        <h4>üöå Active Shuttles</h4>
        <div class="legend-caption">
          <span class="legend-dot legend-dot-today"></span><span>updated today</span>
          <span class="legend-sep">¬∑</span>
          <span class="legend-dot legend-dot-old"></span><span>older</span>
        </div>
        <div class="legend-hide-note"><em>(Tap üôà to hide)</em></div>
      `;

      const visibleSet = new Set();
      const allIds = Object.keys(data).sort();

      for (const id of allIds){
        const rows = data[id];
        if (!rows || !rows.length) continue;

        const latest = rows[0];
        const lat = +latest.lat;
        const lng = +latest.lng;
        if (!isFinite(lat) || !isFinite(lng)) continue;

        const isTodayFlag = isTodayDate(latest.timestamp);
        if (onlyToday && !isTodayFlag) {
          if (buses[id]){
            map.removeLayer(buses[id].marker);
            map.removeLayer(buses[id].trail);
          }
          continue;
        }

        if (filterRoute !== 'ALL' && filterRoute !== id){
          if (buses[id]){
            map.removeLayer(buses[id].marker);
            map.removeLayer(buses[id].trail);
          }
          continue;
        }

        visibleSet.add(id);

        if (!buses[id]){
          const color = nextMutedColor();
          const icon  = makeBusIcon(id, color);
          const marker = L.marker([lat,lng], { icon }).addTo(map);
          const trail  = L.polyline([], { color, weight:5, opacity:0.85 }).addTo(map);
          buses[id] = { marker, trail, color, latestRow: latest };
        } else {
          buses[id].latestRow = latest;
          if (!map.hasLayer(buses[id].marker)) buses[id].marker.addTo(map);
          if (!map.hasLayer(buses[id].trail))  buses[id].trail.addTo(map);
        }

        const b = buses[id];
        const dayPts = todaysLimitedRows(rows);
        b.trail.setLatLngs(dayPts.map(p => [ +p.lat, +p.lng ]));
        b.marker.setLatLng([lat,lng]);

        b.trail.setStyle({ opacity:0, weight:0 });

        b.marker.bindPopup( buildPopup(id, latest, '') );

        ensureMarkerClick(id);

        legendEl.appendChild( buildLegendEntry(id, latest, b.color, isTodayFlag) );
      }

      Object.keys(buses).forEach(id=>{
        if (!visibleSet.has(id)){
          if (map.hasLayer(buses[id].marker)) map.removeLayer(buses[id].marker);
          if (map.hasLayer(buses[id].trail))  map.removeLayer(buses[id].trail);
        }
      });

      rebuildBusList(visibleSet);

      if (!firstLoadDone && currentFocusId){
        followEnabled = true;
        btnFollow.textContent = 'üéØ';
        btnFollow.title = 'Follow ON';
        focusBus(currentFocusId, { openPopup:false });
        firstLoadDone = true;
      }

      if (!currentFocusId && busList.length){
        currentFocusId = busList[0];
      }

      Object.keys(buses).forEach(id=>{
        const b = buses[id];
        if (!b) return;
        if (!visibleSet.has(id)){
          b.trail.setStyle({ opacity:0, weight:0 });
          return;
        }
        if (id === currentFocusId){
          b.trail.setStyle({ opacity:0.85, weight:5 });
        } else {
          b.trail.setStyle({ opacity:0, weight:0 });
        }
      });

      if (followEnabled && currentFocusId && buses[currentFocusId]){
        centerTo(buses[currentFocusId].marker.getLatLng());
      }
      highlightLegend(currentFocusId);

      const any = visibleSet.size > 0;
      maybeStatus(any ? `Updated: ${new Date().toLocaleTimeString()}` : 'No shuttles yet');
    }

    async function refresh(){
      try{
        const res = await fetch(WEB_APP_URL + '?json=1', { cache:'no-store' });
        const js = await res.json();
        if (js && js.ok) updateMap(js.buses);
        else maybeStatus('Failed to load data');
      }catch(e){
        maybeStatus('Fetch failed');
        console.warn('Fetch failed:', e);
      }
    }

    refresh();
    setInterval(refresh, REFRESH_SEC*1000);

    /* Controls behaviour */
    btnHome.onclick = ()=>{
      centerTo(HOME);
      followEnabled=false;
      btnFollow.textContent='üö´';
      btnFollow.title='Follow OFF';
      setStatus('Home view (follow OFF)', 2000);
    };

    btnPrev.onclick = ()=>{
      if (!busList.length) return;
      const idx = busList.indexOf(currentFocusId);
      const id  = (idx <= 0) ? busList[busList.length-1] : busList[idx-1];
      followEnabled = true;
      btnFollow.textContent='üéØ';
      btnFollow.title='Follow ON';
      focusBus(id, { openPopup:false });
    };

    btnNext.onclick = ()=>{
      if (!busList.length) return;
      const idx = busList.indexOf(currentFocusId);
      const id  = busList[(idx+1) % busList.length];
      followEnabled = true;
      btnFollow.textContent='üéØ';
      btnFollow.title='Follow ON';
      focusBus(id, { openPopup:false });
    };

    btnRecenter.onclick = ()=>{
      if (currentFocusId && buses[currentFocusId]){
        followEnabled = true;
        btnFollow.textContent='üéØ';
        btnFollow.title='Follow ON';
        centerTo(buses[currentFocusId].marker.getLatLng());
        setStatus('Recentered (follow ON)', 2000);
        highlightLegend(currentFocusId);
      } else {
        setStatus('No focused route', 2000);
      }
    };

    btnMyLoc.onclick = ()=>{
      if (!navigator.geolocation){
        setStatus('Geolocation unsupported', 2000);
        return;
      }
      navigator.geolocation.getCurrentPosition(pos=>{
        const ll = L.latLng(pos.coords.latitude, pos.coords.longitude);
        if (!myLocMarker){
          myLocMarker = L.marker(ll,{
            icon:L.divIcon({
              className:'myloc-marker',
              html: makeCircleChip('üìç', '#1565C0'),
              iconSize:[44,44],
              iconAnchor:[22,22]
            })
          }).addTo(map);
        } else {
          myLocMarker.setLatLng(ll);
        }
        centerTo(ll);
        followEnabled=false;
        btnFollow.textContent='üö´';
        btnFollow.title='Follow OFF';
        setStatus('My location (follow OFF)', 2000);
      }, err=>{
        setStatus('GPS error: ' + err.message, 2000);
      }, { enableHighAccuracy:true });
    };

    btnMapType.onclick = ()=>{
      map.removeLayer(baseLayer);
      baseIdx = (baseIdx+1)%baseOrder.length;
      baseLayer = layers[baseOrder[baseIdx]].addTo(map);
      if (!map.hasLayer(labels)) labels.addTo(map);
      setStatus('Map type switched', 1500);
    };

    btnLegend.onclick = ()=>{
      const collapsed = legendEl.classList.toggle('collapsed');
      legendEl.setAttribute('aria-expanded', String(!collapsed));
      btnLegend.textContent = collapsed ? 'üëÅÔ∏è' : 'üôà';
      btnLegend.title = collapsed ? 'Show Active Shuttles' : 'Hide Active Shuttles';
      setStatus(collapsed ? 'Active shuttles hidden' : 'Active shuttles shown', 2000);
    };

    btnFollow.onclick = ()=>{
      followEnabled = !followEnabled;
      btnFollow.textContent = followEnabled ? 'üéØ' : 'üö´';
      btnFollow.title = followEnabled ? 'Follow ON' : 'Follow OFF';
      setStatus(followEnabled ? 'Follow ON' : 'Follow OFF', 2000);
      if (followEnabled && currentFocusId && buses[currentFocusId]){
        centerTo(buses[currentFocusId].marker.getLatLng());
        highlightLegend(currentFocusId);
      }
    };

    /* Route filter + today only reapply current data */
    routeFilterEl.onchange = ()=>{ if (lastSnapshot) updateMap(lastSnapshot); };
    todayOnlyEl.onchange   = ()=>{ if (lastSnapshot) updateMap(lastSnapshot); };

    /* Wake Lock */
    let wakeLock = null;
    async function requestWakeLock(){
      try{
        if ('wakeLock' in navigator && !wakeLock){
          wakeLock = await navigator.wakeLock.request('screen');
          btnWake.textContent = 'üîÜ';
          btnWake.title = 'Screen awake (tap to release)';
          setStatus('Wake Lock ON', 1500);
          wakeLock.addEventListener('release', () => {
            wakeLock = null;
            btnWake.textContent = 'üí§';
            btnWake.title = 'Keep screen awake (Wake Lock)';
            setStatus('Wake Lock released', 1500);
          });
        }
      }catch(err){
        setStatus('Wake Lock failed: ' + (err && err.message ? err.message : err), 2500);
        btnWake.textContent = 'üí§';
        btnWake.title = 'Keep screen awake (Wake Lock)';
      }
    }
    async function releaseWakeLock(){
      try{
        if (wakeLock){ await wakeLock.release(); }
      }catch{}
      wakeLock = null;
      btnWake.textContent = 'üí§';
      btnWake.title = 'Keep screen awake (Wake Lock)';
      setStatus('Wake Lock OFF', 1200);
    }
    btnWake.onclick = async ()=>{
      if (!('wakeLock' in navigator)){
        setStatus('Wake Lock not supported on this browser', 2500);
        btnWake.disabled = true;
        btnWake.title = 'Wake Lock not supported';
        return;
      }
      if (wakeLock) await releaseWakeLock();
      else await requestWakeLock();
    };
    document.addEventListener('visibilitychange', async ()=>{
      if (document.visibilityState === 'visible' && wakeLock){
        wakeLock = null;
        await requestWakeLock();
      }
    });
    if (!('wakeLock' in navigator)){
      btnWake.disabled = true;
      btnWake.title = 'Wake Lock not supported';
    }

    /* Logo click: toggle filters panel */
    logoBtn.addEventListener('click', ()=>{
      const isOpen = topbar.classList.toggle('open');
      setStatus(isOpen ? 'Filters shown' : 'Filters hidden', 1000);
    });
  </script>
</body>
</html>
