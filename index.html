<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Live Bus Viewer</title>
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    html, body {
      margin:0;
      height:100%;
      font-family:system-ui, sans-serif;
      background:#fff;
      touch-action:manipulation;
    }
    #map { height:100%; width:100%; }
    body {
      padding-bottom: calc(env(safe-area-inset-bottom, 0) + 4px);
    }
    .leaflet-popup-content { font-size:.9rem; line-height:1.3; }
    .leaflet-div-icon { background:transparent!important; border:none!important; }

    /* Move zoom control to bottom-right, above buttons */
    .leaflet-control-zoom {
      position:absolute;
      bottom:56px;
      right:10px;
      top:auto;
      left:auto;
    }

    /* Title overlay ‚Äì WHITE text + thin black outline + soft gold glow */
    .title-overlay {
      position:absolute;
      top:6px;
      left:50%;
      transform:translateX(-50%);
      z-index:750;

      font-size:1.32rem;
      font-weight:800;

      color:#ffffff;

      text-shadow:
        -1px 0   0 rgba(0,0,0,0.95),
         1px 0   0 rgba(0,0,0,0.95),
         0  -1px 0 rgba(0,0,0,0.95),
         0   1px 0 rgba(0,0,0,0.95),
        0 0 4px  rgba(255,215,0,0.40),
        0 0 8px  rgba(255,215,0,0.30),
        0 0 12px rgba(255,215,0,0.20);

      animation: goldBreath 3s ease-in-out infinite;
      pointer-events:none;
      white-space:nowrap;
    }

    @keyframes goldBreath {
      0% {
        text-shadow:
          -1px 0   0 rgba(0,0,0,0.95),
           1px 0   0 rgba(0,0,0,0.95),
           0  -1px 0 rgba(0,0,0,0.95),
           0   1px 0 rgba(0,0,0,0.95),
          0 0 4px  rgba(255,215,0,0.40),
          0 0 8px  rgba(255,215,0,0.30),
          0 0 12px rgba(255,215,0,0.20);
      }
      50% {
        text-shadow:
          -1px 0   0 rgba(0,0,0,0.95),
           1px 0   0 rgba(0,0,0,0.95),
           0  -1px 0 rgba(0,0,0,0.95),
           0   1px 0 rgba(0,0,0,0.95),
          0 0 6px  rgba(255,223,80,0.55),
          0 0 12px rgba(255,223,80,0.45),
          0 0 18px rgba(255,223,80,0.35);
      }
      100% {
        text-shadow:
          -1px 0   0 rgba(0,0,0,0.95),
           1px 0   0 rgba(0,0,0,0.95),
           0  -1px 0 rgba(0,0,0,0.95),
           0   1px 0 rgba(0,0,0,0.95),
          0 0 4px  rgba(255,215,0,0.40),
          0 0 8px  rgba(255,215,0,0.30),
          0 0 12px rgba(255,215,0,0.20);
      }
    }

    /* Green status label (between title & logo) */
    .status {
      position:absolute;
      top:110px;
      left:50%;
      transform:translateX(-50%);
      z-index:755;
      padding:4px 8px;
      background:#004d00;
      color:#fff;
      font-size:.78rem;
      border-radius:6px;
      white-space:nowrap;
      box-shadow:0 2px 4px rgba(0,0,0,.35);
    }

    /* Top bar (logo + collapsible filters) */
    .topbar {
      position:absolute;
      top:44px;
      left:50%;
      transform:translateX(-50%);
      z-index:760;
      display:flex;
      align-items:center;
      gap:8px;

      background:transparent;
      padding:0;
      border-radius:999px;
      box-shadow:none;
      max-width:calc(100vw - 20px);

      transition:all .25s ease;
    }

    .topbar.open {
      background:rgba(255,255,255,0.94);
      padding:4px 8px;
      box-shadow:0 2px 6px rgba(0,0,0,.25);
    }

    .topbar-inner {
      display:flex;
      align-items:center;
      gap:8px;
      overflow:hidden;
      max-width:0;
      opacity:0;
      transform:scaleX(0);
      transform-origin:right center;
      transition:.25s ease;
      white-space:nowrap;
    }

    .topbar.open .topbar-inner {
      max-width:500px;
      opacity:1;
      transform:scaleX(1);
    }

    .route-filter {
      display:flex;
      align-items:center;
      gap:4px;
      font-size:.82rem;
    }
    .route-filter select {
      border-radius:6px;
      padding:3px 6px;
      font-size:.82rem;
      border:1px solid #ccc;
      background:#fff;
    }

    .today-check {
      display:flex;
      align-items:center;
      gap:3px;
      font-size:.8rem;
      margin-left:4px;
    }

    .logo-btn {
      border:none;
      background:transparent;
      padding:0;
      cursor:pointer;
      border-radius:50%;
      flex-shrink:0;
    }

    /* Breathing + glow for logo (idle) */
    .logo-btn img {
      width:40px;
      height:40px;
      border-radius:50%;
      border:3px solid #ffffff;
      background:#fff;
      object-fit:contain;
      filter:drop-shadow(0 2px 5px rgba(0,0,0,.45));
      animation: logoBreath 2.4s ease-in-out infinite;
    }

    @keyframes logoBreath {
      0% {
        transform:scale(1) rotate(0deg);
        box-shadow:0 0 6px rgba(255,255,255,0.9);
      }
      50% {
        transform:scale(1.09) rotate(3deg);
        box-shadow:0 0 15px rgba(255,255,255,0.7);
      }
      100% {
        transform:scale(1) rotate(0deg);
        box-shadow:0 0 6px rgba(255,255,255,0.9);
      }
    }

    /* Spin animation when filters open */
    .topbar.open .logo-btn img {
      animation: logoSpin 1.2s linear infinite !important;
    }

    @keyframes logoSpin {
      from { transform:rotate(0deg) scale(1); }
      to   { transform:rotate(360deg) scale(1); }
    }

    /* Wobble when tapped */
    .logo-btn.wobble {
      animation: logoWobble .45s ease-out;
    }

    @keyframes logoWobble {
      0%   { transform:scale(1) rotate(0deg); }
      20%  { transform:scale(.95) rotate(-6deg); }
      40%  { transform:scale(1.05) rotate(4deg); }
      60%  { transform:scale(.98) rotate(-3deg); }
      80%  { transform:scale(1.02) rotate(2deg); }
      100% { transform:scale(1) rotate(0deg); }
    }

    /* Bottom-left legend */
    .bottom-left-panel {
      position:absolute;
      left:10px;
      bottom:64px;
      z-index:700;
      display:flex;
      flex-direction:column;
      gap:4px;
      max-width:calc(100vw - 20px);
    }

    .legend {
      background:rgba(255,255,255,.95);
      padding:6px 10px;
      border-radius:8px;
      font-size:.9rem;
      box-shadow:0 2px 6px rgba(0,0,0,.25);
      max-height:60vh;
      overflow-y:auto;
      transition:transform .25s ease, opacity .22s ease;
    }
    .legend h4 { margin:0 0 4px; font-size:.95rem; }

    .legend-caption {
      font-size:.75rem;
      color:#444;
      margin-bottom:2px;
      display:flex;
      align-items:center;
      gap:4px;
      flex-wrap:wrap;
    }
    .legend-dot {
      width:10px;
      height:10px;
      border-radius:50%;
      display:inline-block;
      flex-shrink:0;
    }
    .legend-dot-today { background:#006400; }
    .legend-dot-old { background:#000; }
    .legend-sep {
      margin:0 4px;
      opacity:.7;
    }

    .legend-hide-note {
      font-size:.75rem;
      color:#444;
      font-style:italic;
      margin-bottom:4px;
    }

    .legend-item {
      display:flex;
      align-items:center;
      gap:4px;
      margin:1px 0;
      padding:3px 6px;
      border-radius:8px;
      cursor:pointer;
      transition:.15s ease;
    }
    .legend-item:hover {
      background:#e6f0ff;
    }
    .legend-item.active {
      background:#dbe9ff;
      box-shadow:0 0 0 2px rgba(0,120,255,.25) inset;
    }
    .colorbox {
      width:16px;
      height:10px;
      border-radius:3px;
    }

    .legend.collapsed {
      transform:scaleY(0);
      opacity:0;
      pointer-events:none;
      transform-origin:top left;
    }

    /* ===========================
       BOTTOM BUTTONS: 5-sec wave
       =========================== */
    .controls {
      position:absolute;
      bottom:8px;
      left:50%;
      transform:translateX(-50%);
      display:grid;
      grid-template-columns:repeat(9,36px);
      gap:6px;
      z-index:800;
    }

    .controls button {
      width:36px;
      height:36px;
      border:none;
      border-radius:10px;
      font-size:18px;
      cursor:pointer;
      background:rgba(255,255,255,.95);
      box-shadow:0 2px 6px rgba(0,0,0,.25);

      /* Slow 5-second wave animation */
      animation: buttonHop 5s ease-in-out infinite;
    }

    @keyframes buttonHop {
      0%, 70%, 100% {
        transform:translateY(0);
      }
      20% {
        transform:translateY(-4px);
      }
      40% {
        transform:translateY(0);
      }
    }

    /* Stagger delays */
    .controls button:nth-child(1) { animation-delay:0s; }
    .controls button:nth-child(2) { animation-delay:.2s; }
    .controls button:nth-child(3) { animation-delay:.4s; }
    .controls button:nth-child(4) { animation-delay:.6s; }
    .controls button:nth-child(5) { animation-delay:.8s; }
    .controls button:nth-child(6) { animation-delay:1.0s; }
    .controls button:nth-child(7) { animation-delay:1.2s; }
    .controls button:nth-child(8) { animation-delay:1.4s; }
    .controls button:nth-child(9) { animation-delay:1.6s; }

    .controls button:active { transform:scale(.97); }
    .controls button[disabled] { opacity:.5; cursor:not-allowed; }

    /* Hide attribution */
    .leaflet-control-attribution { display:none!important; }
  </style>
</head>
<body>
  <div class="title-overlay">WIDAD UC SHUTTLE TRACKER</div>

  <div class="status" id="status">Loading‚Ä¶</div>

  <div class="topbar" id="topbar">
    <div class="topbar-inner">
      <div class="route-filter">
        <label>Route:</label>
        <select id="routeFilter"><option value="ALL">All Routes</option></select>
        <label class="today-check"><input type="checkbox" id="todayOnly"> Today only</label>
      </div>
    </div>

    <button class="logo-btn" id="logoBtn" title="Tap to show/hide filters">
      <img src="https://upload.wikimedia.org/wikipedia/commons/2/25/Widad_University_College_Logo.jpg" alt="Widad UC Logo">
    </button>
  </div>

  <div id="map"></div>

  <div class="bottom-left-panel">
    <div class="legend" id="legend">
      <h4>üöå Active Shuttles</h4>
      <div class="legend-caption">
        <span class="legend-dot legend-dot-today"></span><span>updated today</span>
        <span class="legend-sep">¬∑</span>
        <span class="legend-dot legend-dot-old"></span><span>older</span>
      </div>
      <div class="legend-hide-note"><em>(Tap üôà to hide)</em></div>
    </div>
  </div>

  <div class="controls">
    <button id="btnHome" title="Home">üè†</button>
    <button id="btnPrev" title="Previous route">‚óÄÔ∏è</button>
    <button id="btnRecenter" title="Recenter">üîÑ</button>
    <button id="btnNext" title="Next route">‚ñ∂Ô∏è</button>
    <button id="btnMyLoc" title="My location">üìç</button>
    <button id="btnMapType" title="Switch map">üó∫Ô∏è</button>
    <button id="btnLegend" title="Hide Active Shuttles">üôà</button>
    <button id="btnFollow" title="Follow shuttle">üéØ</button>
    <button id="btnWake" title="Keep screen on">üí§</button>
  </div>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    /* Prevent double-tap zoom on iOS */
    let lastTouchEnd = 0;
    document.addEventListener("touchend", function (event) {
      const now = Date.now();
      if (now - lastTouchEnd <= 300) event.preventDefault();
      lastTouchEnd = now;
    }, { passive:false });

    const WEB_APP_URL =
      "https://script.google.com/macros/s/AKfycby6mh0UYXsQyms8ZHWGl5fgDM2yUCBH7TfQ53zTS810KGLS8rLFFcijVTpGpoo2Ab5uAg/exec";
    const REFRESH_SEC = 10;
    const TRAIL_LIMIT_PER_DAY = 200;
    const HOME = L.latLng(3.8235798, 103.2799927);

    const legendEl = document.getElementById("legend");
    const statusEl = document.getElementById("status");
    const routeFilterEl = document.getElementById("routeFilter");
    const todayOnlyEl = document.getElementById("todayOnly");
    const topbar = document.getElementById("topbar");
    const logoBtn = document.getElementById("logoBtn");

    const btnHome = document.getElementById("btnHome");
    const btnPrev = document.getElementById("btnPrev");
    const btnRecenter = document.getElementById("btnRecenter");
    const btnNext = document.getElementById("btnNext");
    const btnMyLoc = document.getElementById("btnMyLoc");
    const btnMapType = document.getElementById("btnMapType");
    const btnLegend = document.getElementById("btnLegend");
    const btnFollow = document.getElementById("btnFollow");
    const btnWake = document.getElementById("btnWake");

    const map = L.map("map", {
      zoomControl: true,
      attributionControl: false
    }).setView(HOME, 13);

    const layers = {
      osm: L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png"),
      esriImagery: L.tileLayer(
        "https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}"
      ),
      esriStreets: L.tileLayer(
        "https://server.arcgisonline.com/ArcGIS/rest/services/World_Street_Map/MapServer/tile/{z}/{y}/{x}"
      )
    };

    map.createPane("labels");
    map.getPane("labels").style.zIndex = 650;
    map.getPane("labels").style.pointerEvents = "none";

    const labels = L.tileLayer(
      "https://stamen-tiles.a.ssl.fastly.net/toner-labels/{z}/{x}/{y}.png",
      { pane: "labels", opacity: 0.9 }
    );

    let baseOrder = ["osm", "esriImagery", "esriStreets"],
        baseIdx = 0;
    let baseLayer = layers[baseOrder[baseIdx]].addTo(map);
    if (!map.hasLayer(labels)) labels.addTo(map);

    function makeCircleChip(icon, border) {
      return `
        <div style="
          width:40px;height:40px;
          border-radius:50%;
          background:#fff;
          border:3px solid ${border};
          display:flex;
          align-items:center;
          justify-content:center;
          box-shadow:0 2px 6px rgba(0,0,0,.3);
        ">
          <div style="font-size:20px;">${icon}</div>
        </div>
      `;
    }

    /* HOME marker ‚Äì default layer (below focused bus) */
    const homeMarker = L.marker(HOME, {
      icon: L.divIcon({
        html: makeCircleChip("üè´", "#2E7D32"),
        iconSize: [44, 44],
        iconAnchor: [22, 22]
      })
    }).addTo(map);
    homeMarker.setZIndexOffset(0);
    homeMarker.setOpacity(1);

    let statusHoldUntil = 0;
    function setStatus(msg, holdMs = 0) {
      statusEl.textContent = msg;
      statusHoldUntil = holdMs > 0 ? Date.now() + holdMs : 0;
    }
    function maybeStatus(msg) {
      if (Date.now() > statusHoldUntil) statusEl.textContent = msg;
    }

    const mutedPalette = [
      "#2E86AB","#6C5B7B","#E07A5F","#3D405B","#8D99AE",
      "#2A9D8F","#7F7CAF","#E76F51","#5C677D","#9C6644",
      "#5B8FB9","#7D7461","#B56576","#6B705C","#7A9E9F"
    ];
    let colorIdx = 0;
    const nextColor = () => mutedPalette[colorIdx++ % mutedPalette.length];

    function makeBusIcon(id, color) {
      return L.divIcon({
        html: `
          <div style="
            width:44px;height:44px;border-radius:50%;
            background:#fff;border:3px solid ${color};
            display:flex;flex-direction:column;align-items:center;justify-content:center;
            box-shadow:0 2px 6px rgba(0,0,0,.3);
          ">
            <div style="font-size:12px;color:${color};font-weight:700;">${id}</div>
            <div style="font-size:20px;">üöå</div>
          </div>`,
        iconSize: [44, 44],
        iconAnchor: [22, 22]
      });
    }

    const buses = {};
    let busList = [];
    let currentFocus = null;
    let myLocMarker = null;
    let followEnabled = true;
    let firstLoadDone = false;
    let lastSnapshot = null;

    function centerTo(ll) {
      map.setView(ll, map.getZoom(), { animate: true });
    }

    function isToday(ts) {
      if (!ts) return false;
      return new Date(ts).toDateString() === new Date().toDateString();
    }

    function todaysRows(rows) {
      const today = new Date().toDateString();
      const todayPts = rows.filter(
        (r) => new Date(r.timestamp).toDateString() === today
      );
      return todayPts.slice(0, TRAIL_LIMIT_PER_DAY).reverse();
    }

    const addrCache = new Map();
    async function getAddress(lat, lng) {
      const key = lat.toFixed(5) + "," + lng.toFixed(5);
      if (addrCache.has(key)) return addrCache.get(key);

      try {
        const res = await fetch(
          `https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lng}`
        );
        const js = await res.json();
        const name = js.display_name || "";
        addrCache.set(key, name);
        return name;
      } catch (e) {
        addrCache.set(key, "");
        return "";
      }
    }

    function popupHTML(id, r, addr) {
      const lines = [];
      if (r.destination) lines.push("Destination: " + r.destination);
      if (r.driver) lines.push("Driver: " + r.driver);
      if (r.plate) lines.push("Plate: " + r.plate);
      if (r.speed_mps > 0)
        lines.push("Speed: " + (r.speed_mps * 3.6).toFixed(1) + " km/h");
      if (addr) lines.push("Location: " + addr);
      if (r.timestamp)
        lines.push("Last update: " + new Date(r.timestamp).toLocaleString());

      const link = `https://www.google.com/maps?q=${r.lat},${r.lng}`;
      const dir = `https://www.google.com/maps/dir/?api=1&destination=${r.lat},${r.lng}`;

      return `<b>Route ${id}</b><br>${lines.join("<br>")}
        <br><a href="${link}" target="_blank">üìç Open in Maps</a>
        &nbsp;&nbsp;<a href="${dir}" target="_blank">üöó Directions</a>`;
    }

    function populateRoutes(data) {
      const existing = new Set();
      existing.add("ALL");
      Object.keys(data).forEach((k) => existing.add(k));

      const curr = routeFilterEl.value || "ALL";

      routeFilterEl.innerHTML = "";
      existing.forEach((v) => {
        const o = document.createElement("option");
        o.value = v;
        o.textContent = v === "ALL" ? "All Routes" : v;
        routeFilterEl.appendChild(o);
      });

      routeFilterEl.value = existing.has(curr) ? curr : "ALL";
    }

    function rebuildBusList(set) {
      const arr = Array.from(set);
      arr.sort();
      busList = arr;
      if (!currentFocus || !set.has(currentFocus)) {
        currentFocus = busList[0] || null;
      }
    }

    function highlightLegend(id) {
      document
        .querySelectorAll(".legend-item")
        .forEach((x) => x.classList.remove("active"));
      if (!id) return;
      const found = document.querySelector(
        `.legend-item[data-id="${CSS.escape(id)}"]`
      );
      if (found) found.classList.add("active");
    }

    function applyHomeMyOpacityForFocus() {
      if (currentFocus && buses[currentFocus]) {
        homeMarker.setOpacity(0.6);
        if (myLocMarker) myLocMarker.setOpacity(0.6);
      } else {
        homeMarker.setOpacity(1);
        if (myLocMarker) myLocMarker.setOpacity(1);
      }
    }

    function focusBus(id, openPopup = false) {
      if (!id || !buses[id]) return;
      currentFocus = id;

      Object.keys(buses).forEach((k) => {
        const bus = buses[k];
        if (k === id) {
          bus.marker.setZIndexOffset(2000);   // focused bus on top
          bus.trail.bringToFront();
          bus.trail.setStyle({ opacity: 0.85, weight: 5 });
        } else {
          bus.marker.setZIndexOffset(0);
          bus.trail.setStyle({ opacity: 0, weight: 0 });
        }
      });

      // When a bus is focused ‚Üí home & my location fade slightly and stay below
      homeMarker.setZIndexOffset(0);
      if (myLocMarker) myLocMarker.setZIndexOffset(0);
      homeMarker.setOpacity(0.6);
      if (myLocMarker) myLocMarker.setOpacity(0.6);

      if (followEnabled) centerTo(buses[id].marker.getLatLng());
      if (openPopup) buses[id].marker.openPopup();

      highlightLegend(id);
      setStatus("Focused: Route " + id, 2000);
    }

    function ensureMarkerClick(id) {
      const b = buses[id];
      if (!b || b._clickBound) return;

      b.marker.on("click", async () => {
        const ll = b.marker.getLatLng();
        const addr = await getAddress(ll.lat, ll.lng);
        const r = b.latestRow || {};
        b.marker.bindPopup(popupHTML(id, r, addr)).openPopup();
        focusBus(id, false);
      });

      b._clickBound = true;
    }

    function makeLegendItem(id, row, color, fresh) {
      const d = document.createElement("div");
      d.className = "legend-item";
      d.dataset.id = id;

      const c = document.createElement("div");
      c.className = "colorbox";
      c.style.background = color;

      const t = document.createElement("div");
      t.textContent = row.destination ? `${id} (${row.destination})` : id;
      t.style.color = fresh ? "#006400" : "#000";

      d.appendChild(c);
      d.appendChild(t);

      d.onclick = () => {
        followEnabled = true;
        btnFollow.textContent = "üéØ";
        focusBus(id, false);
      };

      return d;
    }

    map.on("dragstart", () => {
      followEnabled = false;
      btnFollow.textContent = "üö´";
      setStatus("Follow OFF (map moved)", 2000);
    });

    map.on("zoomstart", () => {
      followEnabled = false;
      btnFollow.textContent = "üö´";
      setStatus("Follow OFF (zoom)", 2000);
    });

    async function updateMap(data) {
      lastSnapshot = data;
      populateRoutes(data);

      const filter = routeFilterEl.value || "ALL";
      const onlyToday = todayOnlyEl.checked;

      legendEl.innerHTML = `
        <h4>üöå Active Shuttles</h4>
        <div class="legend-caption">
          <span class="legend-dot legend-dot-today"></span><span>updated today</span>
          <span class="legend-sep">¬∑</span>
          <span class="legend-dot legend-dot-old"></span><span>older</span>
        </div>
        <div class="legend-hide-note"><em>(Tap üôà to hide)</em></div>
      `;

      const visible = new Set();
      const ids = Object.keys(data).sort();

      for (const id of ids) {
        const rows = data[id];
        if (!rows?.length) continue;

        const latest = rows[0];
        const lat = +latest.lat,
              lng = +latest.lng;
        if (!isFinite(lat) || !isFinite(lng)) continue;

        const fresh = isToday(latest.timestamp);

        if (onlyToday && !fresh) {
          if (buses[id]) {
            map.removeLayer(buses[id].marker);
            map.removeLayer(buses[id].trail);
          }
          continue;
        }

        if (filter !== "ALL" && filter !== id) {
          if (buses[id]) {
            map.removeLayer(buses[id].marker);
            map.removeLayer(buses[id].trail);
          }
          continue;
        }

        visible.add(id);

        if (!buses[id]) {
          const color = nextColor();
          const icon = makeBusIcon(id, color);
          const marker = L.marker([lat, lng], { icon }).addTo(map);
          const trail = L.polyline([], { color, weight: 5, opacity: 0.85 }).addTo(map);
          buses[id] = { marker, trail, color, latestRow: latest };
        } else {
          const b = buses[id];
          b.latestRow = latest;
          if (!map.hasLayer(b.marker)) b.marker.addTo(map);
          if (!map.hasLayer(b.trail)) b.trail.addTo(map);
        }

        const b = buses[id];
        const pts = todaysRows(rows);
        b.trail.setLatLngs(pts.map((p) => [+p.lat, +p.lng]));
        b.marker.setLatLng([lat, lng]);

        // Default non-focused styling
        b.marker.setZIndexOffset(0);
        b.trail.setStyle({ opacity: 0, weight: 0 });

        b.marker.bindPopup(popupHTML(id, latest, ""));
        ensureMarkerClick(id);

        legendEl.appendChild(makeLegendItem(id, latest, b.color, fresh));
      }

      Object.keys(buses).forEach((id) => {
        if (!visible.has(id)) {
          if (map.hasLayer(buses[id].marker)) map.removeLayer(buses[id].marker);
          if (map.hasLayer(buses[id].trail)) map.removeLayer(buses[id].trail);
        }
      });

      rebuildBusList(visible);

      if (!firstLoadDone && currentFocus) {
        followEnabled = true;
        btnFollow.textContent = "üéØ";
        focusBus(currentFocus, false);
        firstLoadDone = true;
      }

      if (!currentFocus && busList.length) currentFocus = busList[0];

      Object.keys(buses).forEach((id) => {
        const b = buses[id];
        if (!b) return;
        if (!visible.has(id)) {
          b.trail.setStyle({ opacity: 0, weight: 0 });
          return;
        }
        if (id === currentFocus) {
          b.trail.setStyle({ opacity: 0.85, weight: 5 });
          b.marker.setZIndexOffset(2000);
        } else {
          b.trail.setStyle({ opacity: 0, weight: 0 });
          b.marker.setZIndexOffset(0);
        }
      });

      if (followEnabled && currentFocus && buses[currentFocus]) {
        centerTo(buses[currentFocus].marker.getLatLng());
      }

      highlightLegend(currentFocus);

      // Sync home/my-location opacity according to focus
      applyHomeMyOpacityForFocus();

      maybeStatus(
        visible.size > 0
          ? "Updated: " + new Date().toLocaleTimeString()
          : "No shuttles"
      );
    }

    async function refresh() {
      try {
        const res = await fetch(WEB_APP_URL + "?json=1", { cache: "no-store" });
        const js = await res.json();
        if (js?.ok) updateMap(js.buses);
        else maybeStatus("Failed to load");
      } catch (e) {
        maybeStatus("Fetch failed");
      }
    }

    refresh();
    setInterval(refresh, REFRESH_SEC * 1000);

    /* Controls */
    btnHome.onclick = () => {
      centerTo(HOME);
      followEnabled = false;
      btnFollow.textContent = "üö´";
      setStatus("Home view (follow OFF)", 2000);

      // Home on top & fully opaque when explicitly selected
      homeMarker.setZIndexOffset(2500);
      homeMarker.setOpacity(1);
      if (myLocMarker) {
        myLocMarker.setZIndexOffset(0);
        myLocMarker.setOpacity(1);
      }
      Object.keys(buses).forEach(id => {
        if (buses[id]) buses[id].marker.setZIndexOffset(0);
      });

      // Clear bus focus fade effect
      currentFocus = null;
    };

    btnPrev.onclick = () => {
      if (!busList.length) return;
      const i = busList.indexOf(currentFocus);
      const id = i <= 0 ? busList[busList.length - 1] : busList[i - 1];
      followEnabled = true;
      btnFollow.textContent = "üéØ";
      focusBus(id, false);
    };

    btnNext.onclick = () => {
      if (!busList.length) return;
      const i = busList.indexOf(currentFocus);
      const id = busList[(i + 1) % busList.length];
      followEnabled = true;
      btnFollow.textContent = "üéØ";
      focusBus(id, false);
    };

    btnRecenter.onclick = () => {
      if (!currentFocus || !buses[currentFocus]) {
        setStatus("No focused route", 2000);
        return;
      }
      followEnabled = true;
      btnFollow.textContent = "üéØ";
      centerTo(buses[currentFocus].marker.getLatLng());
      highlightLegend(currentFocus);
      setStatus("Recentered", 2000);

      // Focused bus should stay highest
      Object.keys(buses).forEach(id => {
        if (buses[id]) buses[id].marker.setZIndexOffset(id === currentFocus ? 2000 : 0);
      });
      // Home/my-location stay faded under focused bus
      applyHomeMyOpacityForFocus();
    };

    btnMyLoc.onclick = () => {
      if (!navigator.geolocation) {
        setStatus("GPS not supported", 2000);
        return;
      }
      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const ll = L.latLng(pos.coords.latitude, pos.coords.longitude);
          if (!myLocMarker) {
            myLocMarker = L.marker(ll, {
              icon: L.divIcon({
                html: makeCircleChip("üìç", "#1565C0"),
                iconSize: [44, 44],
                iconAnchor: [22, 22]
              })
            }).addTo(map);
          } else {
            myLocMarker.setLatLng(ll);
          }

          // My location on top & full opacity when explicitly selected
          myLocMarker.setZIndexOffset(2500);
          myLocMarker.setOpacity(1);
          homeMarker.setZIndexOffset(0);
          homeMarker.setOpacity(1);
          Object.keys(buses).forEach(id => {
            if (buses[id]) buses[id].marker.setZIndexOffset(0);
          });

          centerTo(ll);
          followEnabled = false;
          btnFollow.textContent = "üö´";
          setStatus("My location (follow OFF)", 2000);

          // Clear bus focus fade effect
          currentFocus = null;
        },
        (err) => {
          setStatus("GPS error: " + err.message, 2000);
        },
        { enableHighAccuracy: true }
      );
    };

    btnMapType.onclick = () => {
      map.removeLayer(baseLayer);
      baseIdx = (baseIdx + 1) % baseOrder.length;
      baseLayer = layers[baseOrder[baseIdx]].addTo(map);
      if (!map.hasLayer(labels)) labels.addTo(map);
      setStatus("Map type switched", 1500);
    };

    btnLegend.onclick = () => {
      const collapsed = legendEl.classList.toggle("collapsed");
      btnLegend.textContent = collapsed ? "üëÅÔ∏è" : "üôà";
      btnLegend.title = collapsed ? "Show Active Shuttles" : "Hide Active Shuttles";
      setStatus(collapsed ? "Legend hidden" : "Legend shown", 2000);
    };

    btnFollow.onclick = () => {
      followEnabled = !followEnabled;
      btnFollow.textContent = followEnabled ? "üéØ" : "üö´";
      setStatus(followEnabled ? "Follow ON" : "Follow OFF", 2000);

      if (followEnabled && currentFocus && buses[currentFocus]) {
        centerTo(buses[currentFocus].marker.getLatLng());
        highlightLegend(currentFocus);
      }
    };

    let wakeLock = null;
    async function requestWakeLock() {
      try {
        if ("wakeLock" in navigator && !wakeLock) {
          wakeLock = await navigator.wakeLock.request("screen");
          btnWake.textContent = "üîÜ";
          setStatus("Wake Lock ON", 1500);
          wakeLock.addEventListener("release", () => {
            wakeLock = null;
            btnWake.textContent = "üí§";
          });
        }
      } catch (e) {
        setStatus("Wake Lock failed", 2000);
      }
    }
    async function releaseWakeLock() {
      try {
        if (wakeLock) await wakeLock.release();
      } catch {}
      wakeLock = null;
      btnWake.textContent = "üí§";
      setStatus("Wake Lock OFF", 1200);
    }

    btnWake.onclick = async () => {
      if (!("wakeLock" in navigator)) {
        setStatus("Wake Lock not supported", 2000);
        btnWake.disabled = true;
        return;
      }
      if (wakeLock) await releaseWakeLock();
      else await requestWakeLock();
    };

    document.addEventListener("visibilitychange", async () => {
      if (document.visibilityState === "visible" && wakeLock) {
        wakeLock = null;
        await requestWakeLock();
      }
    });

    /* Logo button tap ‚Üí wobble + open/close filters */
    logoBtn.addEventListener("click", () => {
      logoBtn.classList.add("wobble");
      const open = topbar.classList.toggle("open");
      setStatus(open ? "Filters shown" : "Filters hidden", 1200);
    });

    logoBtn.addEventListener("animationend", (e) => {
      if (e.animationName === "logoWobble") {
        logoBtn.classList.remove("wobble");
      }
    });

    /* Filter changes rerender current snapshot */
    routeFilterEl.onchange  = () => { if (lastSnapshot) updateMap(lastSnapshot); };
    todayOnlyEl.onchange    = () => { if (lastSnapshot) updateMap(lastSnapshot); };
  </script>
</body>
</html>
